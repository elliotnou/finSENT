name: Central Bank Divergence Pipeline

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:

      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo docker image prune --all --force

      - name: Checkout Code (without LFS)
        uses: actions/checkout@v4

      - name: Cache LFS model file
        id: cache-model
        uses: actions/cache@v4
        with:
          path: backend/analysis/model/export/model.pt
          key: lfs-model-v2

      - name: Validate cached model
        id: validate-cache
        run: |
          MODEL_FILE="backend/analysis/model/export/model.pt"
          FILE_SIZE=$(wc -c < "$MODEL_FILE" 2>/dev/null || echo 0)
          if [ "$FILE_SIZE" -lt 1000000 ] || head -c 7 "$MODEL_FILE" 2>/dev/null | grep -q "version"; then
            echo "Cached model is invalid (pointer or missing). Will re-download."
            echo "valid=false" >> "$GITHUB_OUTPUT"
          else
            echo "Cached model is valid ($FILE_SIZE bytes)."
            echo "valid=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Pull LFS model
        if: steps.validate-cache.outputs.valid != 'true'
        run: |
          git lfs install
          git lfs pull --include="backend/analysis/model/export/model.pt"
          MODEL_FILE="backend/analysis/model/export/model.pt"
          FILE_SIZE=$(wc -c < "$MODEL_FILE")
          echo "model.pt size after LFS pull: $FILE_SIZE bytes"
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "FATAL: LFS pull failed. File is $FILE_SIZE bytes (expected ~266MB)."
            echo "Your GitHub LFS bandwidth may be exhausted."
            echo "Check: https://github.com/settings/billing"
            exit 1
          fi
          echo "Model downloaded successfully."

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Execute Pipeline
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python backend/scrapers/boc_scraper.py

          python backend/scrapers/fed_scraper.py

          python backend/analysis/batch_processor.py